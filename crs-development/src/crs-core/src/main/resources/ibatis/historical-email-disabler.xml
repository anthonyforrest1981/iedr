<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "sql-map-2.dtd">

<sqlMap namespace="histemaildisabler">

    <resultMap id="histEmailDisablerShortResultObject" class="pl.nask.crs.commons.email.EmailDisabler">
        <result property="emailTemplate.id" column="emailId" />
        <result property="nicHandle" column="nicHandle"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="disabled" column="disabled"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler" />
        <result property="changeDate" column="changeDate" />
    </resultMap>

    <resultMap id="histEmailDisablerResult" class="pl.nask.crs.history.HistoricalObject">
        <result property="object"
            resultMap="histemaildisabler.histEmailDisablerShortResultObject" />
        <result property="changeId" column="histChangeId" />
        <result property="changedBy" column="histChangedBy"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="changeDate" column="histChangeDate" />
    </resultMap>

    <sql id="selectDisabler">
        SELECT
        EmailDisablerHist.Chng_ID as histChangeId,
        EmailHist.E_ID as emailId,
        NicHandleHist.Nic_Handle as nicHandle,
        ED_Disabled as disabled,
        ED_Change_TS as changeDate,
        EmailDisablerHist.Chng_NH as histChangedBy,
        EmailDisablerHist.Chng_TS as histChangeDate
        FROM
        EmailDisablerHist
        LEFT JOIN EmailHist ON EmailDisablerHist.ED_Email_Chng_ID = EmailHist.Chng_ID
        LEFT JOIN NicHandleHist ON EmailDisablerHist.ED_Nic_Handle_Chng_ID = NicHandleHist.Chng_ID
    </sql>

    <select id="get" parameterClass="pl.nask.crs.commons.email.search.HistoricalEmailDisablerKey"
        resultMap="histEmailDisablerResult">
        <include refid="selectDisabler" />
        WHERE
        EmailHist.E_ID = #emailId#
        AND
        NicHandleHist.Nic_Handle = #nicHandle,handler=pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler#
        AND
        EmailDisablerHist.Chng_ID = #changeId#
    </select>

    <insert id="create">
        INSERT INTO EmailDisablerHist (ED_Email_Chng_ID, ED_Nic_Handle_Chng_ID, ED_Disabled, ED_Change_TS, Chng_NH, Chng_TS)
        VALUES (
        (SELECT Chng_ID FROM Email WHERE E_ID = #object.emailTemplate.id#),
        (SELECT Chng_ID FROM NicHandle WHERE Nic_Handle = #object.nicHandle,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#),
        #object.disabled,handler=pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler#,
        #object.changeDate,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#,
        #changedBy,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        #changeDate,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#
        )
        <selectKey keyProperty="changeId" resultClass="long">
            SELECT LAST_INSERT_ID() AS histChangeId
        </selectKey>
    </insert>

    <sql id="whereFrag">
        <dynamic prepend="WHERE">
            <isNotNull property="criteria.emailId" prepend="AND">
                EmailHist.E_ID = #criteria.emailId#
            </isNotNull>
            <isNotNull property="criteria.nicHandle" prepend="AND">
                NicHandleHist.Nic_Handle =
                #criteria.nicHandle,handler=pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler#
            </isNotNull>
        </dynamic>
    </sql>

    <select id="find" parameterClass="map" resultMap="histEmailDisablerResult">
        <include refid="selectDisabler" />
        <include refid="whereFrag" />
        <include refid="common.sortFrag" />
        <include refid="common.limitFrag" />
    </select>

    <select id="count" parameterClass="map" resultClass="int">
        SELECT
        COUNT(*)
        FROM
        EmailDisablerHist
        LEFT JOIN EmailHist ON EmailDisablerHist.ED_Email_Chng_ID = EmailHist.Chng_ID
        LEFT JOIN NicHandleHist ON EmailDisablerHist.ED_Nic_Handle_Chng_ID = NicHandleHist.Chng_ID
        <include refid="whereFrag" />
    </select>

</sqlMap>
