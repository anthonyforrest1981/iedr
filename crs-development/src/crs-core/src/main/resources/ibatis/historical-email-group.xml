<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "sql-map-2.dtd">

<sqlMap namespace="histemailgroup">

    <resultMap id="histEmailGroupResultObject" class="pl.nask.crs.commons.email.EmailGroup">
        <result property="id" column="EG_ID" />
        <result property="name" column="EG_Name"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="visible" column="EG_Visible"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.NullableCharToBooleanHandler" />
        <result property="changeDate" column="EG_Change_TS" />
    </resultMap>

    <resultMap id="histEmailGroupResult" class="pl.nask.crs.history.HistoricalObject">
        <result property="object"
            resultMap="histemailgroup.histEmailGroupResultObject" />
        <result property="changeId" column="histChangeId" />
        <result property="changedBy" column="histChangedBy"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="changeDate" column="histChangeDate" />
    </resultMap>

    <sql id="selectGroup">
        SELECT
        Chng_ID as histChangeId,
        EG_ID as EG_ID,
        EG_Name as EG_Name,
        EG_Visible as EG_Visible,
        EG_Change_TS as EG_Change_TS,
        Chng_NH as histChangedBy,
        Chng_TS as histChangeDate
        FROM
        EmailGroupHist
    </sql>

    <select id="get"
        parameterClass="pl.nask.crs.commons.email.search.HistoricalEmailGroupKey"
        resultMap="histEmailGroupResult">
        <include refid="selectGroup" />
        WHERE
        EG_ID = #id#
        AND
        Chng_ID = #changeId#
    </select>

    <insert id="create">
        INSERT INTO EmailGroupHist (EG_ID, EG_Name, EG_Visible, EG_Change_TS, Chng_NH, Chng_TS)
        VALUES (
        #object.id#,
        #object.name,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        #object.visible,handler=pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler#,
        #object.changeDate,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#,
        #changedBy,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        #changeDate,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#
        )
        <selectKey keyProperty="changeId" resultClass="long">
            SELECT
            LAST_INSERT_ID() AS changeId
        </selectKey>
    </insert>

    <sql id="whereFrag">
        <dynamic prepend="WHERE">
            <isNotNull property="criteria.id" prepend="AND">
                EG_ID =
                #criteria.id#
            </isNotNull>
        </dynamic>
    </sql>

    <select id="find" parameterClass="map" resultMap="histEmailGroupResult">
        <include refid="selectGroup" />
        <include refid="whereFrag" />
        <include refid="common.sortFrag" />
        <include refid="common.limitFrag" />
    </select>

    <select id="count" parameterClass="map" resultClass="int">
        SELECT
        COUNT(*)
        FROM
        EmailGroupHist
        <include refid="whereFrag" />
    </select>
</sqlMap>
