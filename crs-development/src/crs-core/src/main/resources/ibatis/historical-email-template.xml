<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "sql-map-2.dtd">

<sqlMap namespace="histemailtemplate">

    <resultMap id="histEmailTemplateResultObject" class="pl.nask.crs.commons.email.EmailTemplate">
        <result property="id" />
        <result property="text"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="subject"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="toList"
            typeHandler="pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler" />
        <result property="ccList"
            typeHandler="pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler" />
        <result property="bccList"
            typeHandler="pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler" />
        <result property="internalToList"
            typeHandler="pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler" />
        <result property="internalCcList"
            typeHandler="pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler" />
        <result property="internalBccList"
            typeHandler="pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler" />
        <result property="mailSmtpFrom"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="active"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler" />
        <result property="html"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler" />
        <result property="suppressible"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler" />
        <result property="sendReason"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="nonSuppressibleReason"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="suppressedByGaining"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler" />
        <result property="group" resultMap="histemailgroup.histEmailGroupResultObject" />
        <result property="changeDate" column="changeDate" />
    </resultMap>

    <resultMap id="histEmailTemplateResult" class="pl.nask.crs.history.HistoricalObject">
        <result property="object"
            resultMap="histemailtemplate.histEmailTemplateResultObject" />
        <result property="changeId" column="histChangeId" />
        <result property="changedBy" column="histChangedBy"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="changeDate" column="histChangeDate" />
    </resultMap>

    <sql id="selectTemplate">
        SELECT
        E_ID as id,
        E_Text as text,
        E_Subject as subject,
        E_To as toList,
        E_CC as ccList,
        E_BCC as bccList,
        E_To_Internal as internalToList,
        E_CC_Internal as internalCcList,
        E_BCC_Internal as internalBccList,
        E_From as mailSmtpFrom,
        active as active,
        Html as html,
        E_Suppressible as suppressible,
        E_Send_Reason as sendReason,
        E_Non_Suppressible_Reason as nonSuppressibleReason,
        eg.EG_ID as EG_ID,
        eg.EG_Name as EG_Name,
        eg.EG_Visible as EG_Visible,
        eg.EG_Change_TS as EG_Change_TS,
        E_Change_TS as changeDate,
        eh.Chng_ID as histChangeId,
        eh.Chng_NH as histChangedBy,
        eh.Chng_TS as histChangeDate
        FROM
        EmailHist eh
        LEFT JOIN
        EmailGroupHist eg ON eh.EG_Chng_ID = eg.Chng_ID
    </sql>

    <select id="get"
        parameterClass="pl.nask.crs.commons.email.search.HistoricalEmailTemplateKey"
        resultMap="histEmailTemplateResult">
        <include refid="selectTemplate" />
        WHERE
        E_ID = #id#
        AND
        eh.Chng_ID = #changeId#
    </select>

    <insert id="create">
        INSERT INTO EmailHist (E_ID, E_Text, E_Subject, E_To, E_CC, E_BCC,
        E_To_Internal, E_CC_Internal, E_BCC_Internal, E_From, active, Html, E_Suppressible,
        E_Send_Reason, E_Non_Suppressible_Reason, EG_Chng_ID, Chng_NH, Chng_TS, E_Change_TS)
        VALUES (
        #object.id#,
        #object.text,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        #object.subject,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        #object.toList,handler=pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler#,
        #object.ccList,handler=pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler#,
        #object.bccList,handler=pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler#,
        #object.internalToList,handler=pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler#,
        #object.internalCcList,handler=pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler#,
        #object.internalBccList,handler=pl.nask.crs.commons.email.dao.ibatis.handlers.LooseContactListHandler#,
        #object.mailSmtpFrom,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        #object.active,handler=pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler#,
        #object.html,handler=pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler#,
        #object.suppressible,handler=pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler#,
        #object.sendReason,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        #object.nonSuppressibleReason,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        (SELECT Chng_ID FROM EmailGroup WHERE EG_ID = #object.group.id#),
        #changedBy,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        #changeDate,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#,
        #changeDate,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#)
        <selectKey keyProperty="changeId" resultClass="long">
            SELECT
            LAST_INSERT_ID() AS changeId
        </selectKey>
    </insert>

    <sql id="whereFrag">
        <dynamic prepend="WHERE">
            <isNotNull property="criteria.id" prepend="AND">
                E_ID = #criteria.id#
            </isNotNull>
        </dynamic>
    </sql>

    <select id="find" parameterClass="map" resultMap="histEmailTemplateResult">
        <include refid="selectTemplate" />
        <include refid="whereFrag" />
        <include refid="common.sortFrag" />
        <include refid="common.limitFrag" />
    </select>

    <select id="count" parameterClass="map" resultClass="int">
        SELECT
        COUNT(*)
        FROM
        EmailHist
        <include refid="whereFrag" />
    </select>
</sqlMap>
