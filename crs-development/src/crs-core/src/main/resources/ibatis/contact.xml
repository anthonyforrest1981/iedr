<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
        PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "sql-map-2.dtd">

<sqlMap namespace="contact">

    <resultMap id="contactResult"
        class="pl.nask.crs.contacts.dao.ibatis.objects.InternalContact">
        <result property="nicHandle" column="nicHandle"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.StringHandler" />
        <result property="name" column="name"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.StringHandler" />
        <result property="email" column="email"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.StringHandler" />
        <result property="companyName" column="companyName"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.StringHandler" />
        <result property="country" column="country"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.StringHandler" />
        <result property="county" column="county"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.StringHandler" />
    </resultMap>

    <sql id="dynamicJoinWhereContact">
        <dynamic>
            <isNotNull property="criteria.type">
                LEFT OUTER JOIN Contact C
                ON
                NH.Nic_Handle = C.Contact_NH
            </isNotNull>
        </dynamic>
        <dynamic prepend="where">
            <isNotNull prepend="and" property="criteria.name">
                NH.NH_Name like
                #criteria.name,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringPrefixHandler#
            </isNotNull>
            <isNotNull prepend="and" property="criteria.nicHandle">
                NH.Nic_Handle =
                #criteria.nicHandle,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#
            </isNotNull>
            <isNotNull prepend="and" property="criteria.type">
                C.Type =
                #criteria.type,handler=pl.nask.crs.contacts.dao.ibatis.handlers.ContactTypeHandler#
            </isNotNull>
            <isNotNull prepend="and" property="criteria.account">
                NH.A_Number =
                #criteria.account#
            </isNotNull>
            <isNotNull prepend="and" property="criteria.companyName">
                Co_Name like
                #criteria.companyName,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringPrefixHandler#
            </isNotNull>
        </dynamic>
    </sql>

    <select id="getContactByNicHandleId" resultMap="contactResult">
        SELECT
        NH.Nic_Handle as nicHandle,
        NH.NH_Name as name,
        NH.NH_Email as email,
        NH.Co_Name as companyName,
        Cntr.Name as country,
        Cnt.Name as county
        FROM NicHandle NH
        LEFT JOIN Countries Cntr ON Cntr.Id = NH.Country_Id
        LEFT JOIN Counties Cnt ON Cnt.Id = NH.County_Id
        WHERE NH.Nic_Handle = #nicHandleId,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#
    </select>

    <select id="findContacts" resultMap="contactResult">
        SELECT
        NH.Nic_Handle as nicHandle,
        NH.NH_Name as name,
        NH.NH_Email as email,
        NH.Co_Name as companyName,
        Cntr.Name as country,
        Cnt.Name as county
        FROM
        NicHandle NH
        LEFT JOIN Countries Cntr ON Cntr.Id = NH.Country_Id
        LEFT JOIN Counties Cnt ON Cnt.Id = NH.County_Id
        <include refid="dynamicJoinWhereContact" />
        <dynamic>
            <isNotNull property="criteria.type">
                GROUP BY NH.Nic_Handle
            </isNotNull>
        </dynamic>
        <include refid="common.limitFrag" />
    </select>

    <select id="countContacts" resultClass="int">
        SELECT
        count(distinct NH.Nic_Handle)
        FROM
        NicHandle NH
        <include refid="dynamicJoinWhereContact" />
    </select>

    <select id="getDefaultTechContact" parameterClass="java.lang.String"
        resultMap="common.normalizedString">
        select
        Tech_C as nicHandle
        from
        Reseller_Defaults
        where
        Nic_Handle =
        #billingContact,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#
    </select>

</sqlMap>

