<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
        PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "sql-map-2.dtd">

<sqlMap namespace="notification">

    <typeAlias alias="dnsNotification" type="pl.nask.crs.dnscheck.DnsNotification" />
    <typeAlias alias="dnsNotificationDate" type="pl.nask.crs.dnscheck.DnsNotificationDate" />

    <resultMap id="dnsNotificationMap" class="pl.nask.crs.dnscheck.DnsNotification">
        <result property="id" />
        <result property="domainName" typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.StringHandler" />
        <result property="ticketNumber" />
        <result property="nsName" typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.StringHandler" />
        <result property="timeOfCheck" />
        <result property="errorMessage" typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.StringHandler" />
    </resultMap>

    <resultMap id="dnsNotificationDateMap" class="pl.nask.crs.dnscheck.DnsNotificationDate">
        <result property="nicHandle" typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.StringHandler" />
        <result property="nextNotificationDate"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler" />
    </resultMap>

    <insert id="insertNotification" parameterClass="dnsNotification">
        INSERT INTO DNS_Check_Notification
        (
        Domain_Name,
        Ticket_Number,
        DNS_Name,
        Check_TS,
        Error_Message
        ) VALUES (
        #domainName,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        #ticketNumber#,
        #nsName,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        #timeOfCheck,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#,
        #errorMessage,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#)
        <selectKey resultClass="int" keyProperty="id">
            SELECT
            LAST_INSERT_ID() AS id
        </selectKey>
    </insert>

    <sql id="selectFrag">
        SELECT
        ID as id,
        Domain_Name as domainName,
        Ticket_Number as ticketNumber,
        DNS_Name as nsName,
        Check_TS as timeOfCheck,
        Error_Message as errorMessage
        FROM
        DNS_Check_Notification
    </sql>

    <select id="getNotificationById" resultMap="dnsNotificationMap">
        <include refid="notification.selectFrag" />
        WHERE ID = #id#
    </select>

    <select id="getNotificationByDomainName" resultMap="dnsNotificationMap">
        <include refid="notification.selectFrag" />
        WHERE
            Domain_Name = #domainName,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#
    </select>

    <select id="getAll" resultMap="dnsNotificationMap">
        <include refid="notification.selectFrag" />
    </select>

    <delete id="removeObsoleteNotificationsForTicket">
        DELETE FROM
        DNS_Check_Notification
        WHERE
        Ticket_Number = #ticketNumber#
        <isNotEmpty property="nsNames" prepend="AND">
            DNS_Name NOT IN
            <iterate open="(" close=")" conjunction=", " property="nsNames">
                #nsNames[],handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#
            </iterate>
        </isNotEmpty>
    </delete>

    <delete id="removeObsoleteNotificationsForDomain">
        DELETE FROM
        DNS_Check_Notification
        WHERE
        Domain_name = #domainName,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#
        AND Ticket_Number IS NULL
        <isNotEmpty property="nsNames" prepend="AND">
            DNS_Name NOT IN
            <iterate open="(" close=")" conjunction=", " property="nsNames">
                #nsNames[],handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#
            </iterate>
        </isNotEmpty>
    </delete>

    <delete id="deleteById" parameterClass="int">
        DELETE FROM
        DNS_Check_Notification
        WHERE
        ID = #id#
    </delete>

    <select id="getNotificationDate" resultMap="dnsNotificationDateMap">
        SELECT
        Nic_Handle as nicHandle,
        Next_Notification_Dt as nextNotificationDate
        FROM
        DNS_Check_Notification_Date
        WHERE
        Nic_Handle = #nicHandleId,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#
    </select>

    <update id="updateNotificationDate" parameterClass="java.util.Map">
        UPDATE
        DNS_Check_Notification_Date
        SET
        Next_Notification_Dt = #date,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#
        WHERE
        Nic_Handle = #nicHandleId,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#
    </update>

    <insert id="createNotificationDate" parameterClass="dnsNotificationDate">
        INSERT
        INTO DNS_Check_Notification_Date
        (Nic_Handle,
        Next_Notification_Dt)
        VALUES
        (#nicHandle,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#,
        #nextNotificationDate,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#)
    </insert>
</sqlMap>

