<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
        PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "sql-map-2.dtd">

<sqlMap namespace="reservation-hist">

    <resultMap id="internalReservation"
        class="pl.nask.crs.payment.dao.ibatis.objects.InternalReservation">
        <result property="id" column="id" />
        <result property="nicHandleId" column="nicHandleId"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="domainName" column="domainName"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="durationMonths" column="durationMonths" />
        <result property="creationDate" column="creationDate" />
        <result property="productId" column="productId" />
        <result property="amount" column="amount"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.MonetaryBigDecimalHandler" />
        <result property="vatId" column="vatId" />
        <result property="vatCategory" column="vatCategory"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="vatFromDate" column="vatFromDate" />
        <result property="vatRate" column="vatRate"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.VatRateHandler" />
        <result property="vatAmount" column="vatAmount"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.MonetaryBigDecimalHandler" />
        <result property="readyForSettlement" column="readyForSettlement"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler" />
        <result property="settled" column="settled"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler" />
        <result property="settledDate" column="settledDate" />
        <result property="ticketId" column="ticketId" />
        <result property="transactionId" column="transactionId" />
        <result property="operationType" column="operationType"
            typeHandler="pl.nask.crs.payment.dao.ibatis.handlers.OperationTypeHandler" />
        <result property="startDate" column="startDate" />
        <result property="endDate" column="endDate" />
        <result property="paymentMethod" column="paymentMethod"
            typeHandler="pl.nask.crs.payment.dao.ibatis.handlers.PaymentMethodHandler" />
        <result property="invoiceNumber" column="invoiceNumber"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
        <result property="orderId" column="orderId"
            typeHandler="pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler" />
    </resultMap>

    <insert id="createHistReservation"
        parameterClass="pl.nask.crs.payment.dao.ibatis.objects.InternalReservation">
        INSERT INTO ReservationHist (
        ID,
        Nic_Handle_Chng_ID,
        Domain_Chng_ID,
        Duration_Months,
        Creation_TS,
        Product_Id,
        Amount,
        Vat_ID,
        Vat_Amount,
        Ready_For_Settlement,
        Settled,
        Settled_TS,
        Ticket_Chng_ID,
        Transaction_ID,
        Operation_Type,
        Payment_Method,
        Period_Start_Dt,
        Period_End_Dt
        ) VALUES (
        #id#,
        (SELECT Chng_ID FROM NicHandle WHERE Nic_Handle =
            #nicHandleId,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#),
        (SELECT Chng_ID FROM Domain WHERE D_Name =
            #domainName,handler=pl.nask.crs.commons.dao.ibatis.handlers.StringHandler#),
        #durationMonths#,
        #creationDate,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#,
        #productId#,
        #amount#,
        #vatId#,
        #vatAmount#,
        #readyForSettlement,handler=pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler#,
        #settled,handler=pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler#,
        #settledDate,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#,
        (SELECT Chng_ID FROM Ticket WHERE T_Number = #ticketId#),
        #transactionId#,
        #operationType,handler=pl.nask.crs.payment.dao.ibatis.handlers.OperationTypeHandler#,
        #paymentMethod,handler=pl.nask.crs.payment.dao.ibatis.handlers.PaymentMethodHandler#,
        #startDate,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#,
        #endDate,handler=pl.nask.crs.commons.dao.ibatis.handlers.TruncatedDateHandler#
        )
    </insert>

    <sql id="selectHistReservation">
        SELECT
        RH.ID as id,
        NHH.Nic_Handle as nicHandleId,
        DH.D_Name as domainName,
        RH.Duration_Months as durationMonths,
        RH.Creation_TS as creationDate,
        RH.Product_Id as productId,
        RH.Amount as amount,
        RH.Vat_ID as vatId,
        Vat.Category as vatCategory,
        Vat.From_Dt as vatFromDate,
        Vat.Rate as vatRate,
        RH.Vat_Amount as vatAmount,
        RH.Ready_For_Settlement as readyForSettlement,
        RH.Settled as settled,
        RH.Settled_TS as settledDate,
        TicketHist.T_Number as ticketId,
        RH.Transaction_ID as transactionId,
        RH.Operation_Type as operationType,
        RH.Period_Start_Dt as startDate,
        RH.Period_End_Dt as endDate,
        RH.Payment_Method as paymentMethod,
        I.Invoice_Number as invoiceNumber,
        TH.Order_ID as orderId,
        <!--for sort only -->
        RH.Amount + RH.Vat_Amount as total
        FROM ReservationHist RH
        JOIN Vat on (Vat_ID=Vat.ID)
        LEFT JOIN TransactionHist TH ON (RH.Transaction_ID = TH.ID)
        LEFT JOIN Invoice I ON (TH.Invoice_ID = I.ID)
        LEFT JOIN NicHandleHist NHH ON (NHH.Chng_ID = RH.Nic_Handle_Chng_ID)
        LEFT JOIN DomainHist DH ON (DH.Chng_ID = RH.Domain_Chng_ID)
        LEFT JOIN TicketHist ON (TicketHist.Chng_ID = RH.Ticket_Chng_ID)
    </sql>

    <select id="getById" resultMap="internalReservation">
        <include refid="selectHistReservation" />
        WHERE
        RH.ID = #id#
    </select>

    <sql id="reservationHistCriteria">
        <dynamic prepend="where">
            <isNotNull prepend="and" property="criteria.settled">
                RH.Settled =
                #criteria.settled,handler=pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler#
            </isNotNull>
            <isNotNull prepend="and" property="criteria.billingNH">
                NHH.Nic_Handle =
                #criteria.billingNH,handler=pl.nask.crs.commons.dao.ibatis.handlers.LooseStringHandler#
            </isNotNull>
            <isNotNull prepend="and" property="criteria.readyForSettlement">
                RH.Ready_For_Settlement =
                #criteria.readyForSettlement,handler=pl.nask.crs.commons.dao.ibatis.handlers.CharToBooleanHandler#
            </isNotNull>
            <isNotNull prepend="and" property="criteria.paymentMethod">
                RH.Payment_Method =
                #criteria.paymentMethod,handler=pl.nask.crs.payment.dao.ibatis.handlers.PaymentMethodHandler#
            </isNotNull>
            <isNotNull prepend="and" property="criteria.operationType">
                RH.Operation_Type =
                #criteria.operationType,handler=pl.nask.crs.payment.dao.ibatis.handlers.OperationTypeHandler#
            </isNotNull>
            <isNotNull prepend="and" property="criteria.domainName">
                DH.D_Name LIKE
                #criteria.domainName,handler=pl.nask.crs.commons.dao.ibatis.handlers.LooseStringPrefixHandler#
            </isNotNull>
            <isNotNull prepend="and" property="criteria.ticketId">
                TicketHist.T_Number =
                #criteria.ticketId#
            </isNotNull>
            <isNotNull prepend="and" property="criteria.transactionId">
                RH.Transaction_ID =
                #criteria.transactionId#
            </isNotNull>
        </dynamic>
    </sql>

    <select id="countFindHistReservations" parameterClass="java.util.Map"
        resultClass="int">
        SELECT
        COUNT(*) as cnt
        FROM
        ReservationHist RH
        LEFT JOIN NicHandleHist NHH ON (NHH.Chng_ID = RH.Nic_Handle_Chng_ID)
        LEFT JOIN DomainHist DH ON (DH.Chng_ID = RH.Domain_Chng_ID)
        LEFT JOIN TicketHist ON (TicketHist.Chng_ID = RH.Ticket_Chng_ID)
        <include refid="reservationHistCriteria" />
    </select>

    <select id="findHistReservations" parameterClass="java.util.Map"
        resultMap="internalReservation">
        <include refid="selectHistReservation" />
        <include refid="reservationHistCriteria" />
        <include refid="common.sortFrag" />
        <include refid="common.limitFrag" />
    </select>

</sqlMap>
